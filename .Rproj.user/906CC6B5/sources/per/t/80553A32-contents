addFeatureStats <- function(sce, value = c("counts", "cpm", "tpm", "fpkm"),
                            log = FALSE, offset = 1, no.zeros = FALSE) {

    checkmate::assertClass(sce, "SingleCellExperiment")
    checkmate::assertLogical(log)
    checkmate::assertNumber(offset, lower = 0)
    checkmate::assertLogical(no.zeros)
    value <- match.arg(value)

    switch(value,
           counts = {
               values = BiocGenerics::counts(sce)
               suffix <- "Counts"
           },
           cpm = {
               values = SingleCellExperiment::cpm(sce)
               suffix <- "CPM"
           },
           tpm = {
               values = SingleCellExperiment::tpm(sce)
               suffix <- "TPM"
           },
           fpkm = {
               values = SummarizedExperiment::assays(sce)$fpkm
               suffix <- "FPKM"
           }
    )

    if (no.zeros) {
        values[values == 0] <- NA
        suffix = paste0(suffix, "No0")
    }

    if (log) {
        values = log2(values + offset)
        suffix = paste0("Log", suffix)
    }

    mean.str <- paste0("Mean", suffix)
    var.str  <- paste0("Var",  suffix)
    cv.str   <- paste0("CV",   suffix)
    med.str  <- paste0("Med",  suffix)
    mad.str  <- paste0("MAD",  suffix)

    rowData(sce)[, mean.str] <- rowMeans(values, na.rm = TRUE)
    rowData(sce)[, var.str]  <- matrixStats::rowVars(values, na.rm = TRUE)
    rowData(sce)[, cv.str]   <- sqrt(rowData(sce)[, var.str]) /
        rowData(sce)[, mean.str]
    rowData(sce)[, med.str]  <- matrixStats::rowMedians(values, na.rm = TRUE)
    rowData(sce)[, mad.str]  <- matrixStats::rowMads(values, na.rm = TRUE)

    return(sce)
}
rbindMatched <- function(df1, df2) {
    common.names <- intersect(colnames(df1), colnames(df2))
    combined <- rbind(df1[, common.names], df2[, common.names])

    return(combined)
}

library(grid)
#####plot_DROPOUT########
cbPalette <- c("#999999", "#E69F00", "#56B4E9")

plot_DROPOUT<-function(listused_N1,MAIN='',CAPTION='',legendpointsize=1,legend_key_size=1,subtitle=''){

library(foreach)
DROPOUT_DAT<-foreach(i=1:length(listused_N1),.combine=rbind)%do%{

    if(names(listused_N1)[i]=='Raw') {colll<-cbPalette[1]}else if(names(listused_N1)[i]=='Binomial'){
        colll<-cbPalette[2]
    } else if(names(listused_N1)[i]=='Scaled raw'){
        colll<-cbPalette[3]
    } else{colll<-cbPalette[1]}

  dropout<-apply(listused_N1[[i]],1,function(x){length(which(x==0))/length(x)})
  meann<-rowMeans(listused_N1[[i]])
  qqq<-cbind(dropout,meann,rep(names(listused_N1)[i],length(dropout)),rep(colll,length(dropout)))
  return(qqq)
}
DROPOUT_DAT<-as.data.frame(DROPOUT_DAT)
colnames(DROPOUT_DAT)<-c('Dropout rate','Mean expression','Dataset','Colour')
DROPOUT_DAT$`Dropout rate`<-as.numeric(as.character(DROPOUT_DAT$`Dropout rate`))
DROPOUT_DAT$`Mean expression`<-as.numeric(as.character(DROPOUT_DAT$`Mean expression`))
DROPOUT_DAT$Dataset<-factor(DROPOUT_DAT$Dataset,levels=unique(DROPOUT_DAT$Dataset))
DROPOUT_DAT$Colour<-factor(DROPOUT_DAT$Colour,levels=unique(DROPOUT_DAT$Colour))



sces<-listused_N1
colours <- scales::hue_pal()(length(sces))

theoline_ref_name<-names(listused_N1)[1]

theoline<-data.frame(xx =sort(DROPOUT_DAT$`Mean expression`[which(DROPOUT_DAT$Dataset==theoline_ref_name)]), yy=exp(-sort(DROPOUT_DAT$`Mean expression`[which(DROPOUT_DAT$Dataset==theoline_ref_name)])))

mean.zeros <- ggplot() +
    geom_line(data=theoline,aes(x=xx,y=yy, lty = 'exp(-mean expression)'))+
    geom_point(data=DROPOUT_DAT,aes_string(x = DROPOUT_DAT$`Mean expression`, y = DROPOUT_DAT$`Dropout rate`,colour = DROPOUT_DAT$Colour),size = point.size, alpha = point.alpha,shape=46) +
  scale_x_log10(labels = scales::comma) +
  xlab("Mean expression") +
  ylab("Dropout rates") +
    scale_color_manual(values=as.character(unique(DROPOUT_DAT$Colour)),labels=names(listused_N1))+
    scale_linetype_manual(values=1,'Black line')+
  labs(x = "Mean expression",y="Dropout rates",fill='Dataset',colour='Dataset',caption=CAPTION,title=MAIN,subtitle=subtitle)+
    theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = 10),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize),legend.key.size = unit(legend_key_size,"line") ,legend.position = c(0.8,0.9))+
    guides(colour = guide_legend(override.aes = list(size=legendpointsize,shape=16,alpha=1)))
return(mean.zeros)
}
#

#


#####mean var#####

plot_MEANVAR<-function(sces,MAIN='',CAPTION=''){

    for (name in names(sces)) {
        sce <- sces[[name]]
        rowData(sce)$Dataset <- name
        colData(sce)$Dataset <- name
        sce <- scater::calculateQCMetrics(sce)
        cpm(sce) <- scater::calculateCPM(sce, use_size_factors = FALSE)
        sce <- addFeatureStats(sce, "counts")
        sce <- addFeatureStats(sce, "cpm")
        sce <- addFeatureStats(sce, "cpm", log = TRUE)
        n.features <- colData(sce)$total_features
        colData(sce)$PctZero <- 100 * (1 - n.features / nrow(sce))
        sces[[name]] <- sce
    }

    features <- rowData(sces[[1]])
    cells <- colData(sces[[1]])

    if (length(sces) > 1) {
        for (name in names(sces)[-1]) {
            sce <- sces[[name]]
            features <- rbindMatched(features, rowData(sce))
            cells <- rbindMatched(cells, colData(sce))
        }
    }
    features$Dataset <- factor(features$Dataset, levels = names(sces))
    cells$Dataset <- factor(cells$Dataset, levels = names(sces))
    features <- data.frame(features)
    cells <- data.frame(cells)


    colours <- scales::hue_pal()(length(sces))



    z.gene <- ggplot(features,
                     aes_string(x = "Dataset", y = "pct_dropout_counts",
                                colour = "Dataset")) +
        geom_violin(show.legend=F)+
        #geom_boxplot() +
        scale_y_continuous(limits = c(0, 100)) +
        scale_colour_manual(values = colours) +
        ylab("Percentage zeros per gene") +
        ggtitle("Distribution of zeros per gene") +
        theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')

    z.cell <- ggplot(cells,
                     aes_string(x = "Dataset", y = "PctZero",
                                colour = "Dataset")) +
        geom_violin(show.legend=F)+
        #geom_boxplot() +
        scale_y_continuous(limits = c(0, 100)) +
        scale_colour_manual(values = colours) +
        ylab("Percentage zeros per cell") +
        ggtitle("Distribution of zeros per cell") +
        theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')



    mean.var <- ggplot(features,
                       aes_string(x = "MeanLogCPM", y = "VarLogCPM",
                                  colour = "Dataset", fill = "Dataset")) +
        geom_point(size = point.size, alpha = point.alpha,shape=46) +
        scale_colour_manual(values = colours) +
        scale_fill_manual(values = colours) +
        guides(colour = guide_legend(override.aes = list(size=legendpointsize,shape=16,alpha=1)))+
        # xlab(expression(paste("Mean", log[2], "(CPM + 1)"))) +
        # ylab(expression(paste("Variance", log[2], "(CPM + 1)"))) +
        xlab("Mean expression") +
        ylab("Variance of gene expression") +
        labs(caption=CAPTION)+
        ggtitle(MAIN) +
        theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(legend_key_size,"line"),legend.position ='top')


    theoline_ref_name<-names(sces)[1]
    theoline<-data.frame(xx =features$mean_counts[which(features$Dataset=='Real')], yy=exp(-features$mean_counts[which(features$Dataset=='Real')]))

    mean.zeros <- ggplot() +
        geom_line(data=theoline,aes(x=xx,y=yy, lty = 'exp(-mean expression)'))+
        geom_point(data=features,
                   aes_string(x = "MeanCounts",y = features$pct_dropout_by_counts/100,colour = "Dataset", fill = "Dataset"),size = point.size, alpha = point.alpha,shape=46) +
        scale_x_log10(labels = scales::comma) +
        scale_colour_manual(values = colours) +
        scale_linetype_manual(values=1,'Black line')+
        scale_fill_manual(values = colours) +
        guides(colour = guide_legend(override.aes = list(size=legendpointsize,shape=16,alpha=1)))+
        labs(x = "Mean expression",y="Dropout rates",fill='Dataset',colour='Dataset',caption=CAPTION,title=MAIN
             ,subtitle=''
             )+
            theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(legend_key_size,"line"),legend.position = 'top')

    library(cowplot)
    #qq<-ggdraw(add_sub(mean.zeros, 'Black line: exp(-mean expression of real data)',x=0.8,y=20))
#qq

    return(list(mean.var=mean.var,z.gene=z.gene,z.cell=z.cell,mean.zeros=mean.zeros))
}
##########difff##############
plot_MEANVAR_diff<-function(sces,MAIN='',CAPTION=''){

    ref<-1
    ref.dim <- dim(sces[[ref]])

    for (name in names(sces)) {
        sce <- sces[[name]]
        if (!identical(dim(sce), ref.dim)) {
            stop("all datasets in 'sces' must have the same dimensions")
        }
        rowData(sce)$Dataset <- name
        colData(sce)$Dataset <- name
        sce <- scater::calculateQCMetrics(sce)
        cpm(sce) <- scater::calculateCPM(sce, use_size_factors  = FALSE)
        sce <- addFeatureStats(sce, "counts")
        sce <- addFeatureStats(sce, "cpm", log = TRUE)
        n.features <- colData(sce)$total_features
        colData(sce)$PctZero <- 100 * (1 - n.features / nrow(sce))
        rowData(sce)$RankCounts <- rank(rowData(sce)$mean_counts)
        sces[[name]] <- sce
    }

    ref.sce <- sces[[ref]]

    ref.means <- sort(rowData(ref.sce)$MeanLogCPM)
    ref.vars <- sort(rowData(ref.sce)$VarLogCPM)
    ref.libs <- sort(colData(ref.sce)$total_counts)
    ref.z.gene <- sort(rowData(ref.sce)$pct_dropout_counts)
    ref.z.cell <- sort(colData(ref.sce)$PctZero)

    ref.rank.ord <- order(rowData(ref.sce)$RankCounts)
    ref.vars.rank <- rowData(ref.sce)$VarLogCPM[ref.rank.ord]
    ref.z.gene.rank <- rowData(ref.sce)$pct_dropout_counts[ref.rank.ord]

    for (name in names(sces)) {
        sce <- sces[[name]]
        rowData(sce)$RefRankMeanLogCPM <- ref.means[
            rank(rowData(sce)$MeanLogCPM)]
        rowData(sce)$RankDiffMeanLogCPM <- rowData(sce)$MeanLogCPM -
            rowData(sce)$RefRankMeanLogCPM
        rowData(sce)$RefRankVarLogCPM <- ref.vars[rank(rowData(sce)$VarLogCPM)]
        rowData(sce)$RankDiffVarLogCPM <- rowData(sce)$VarLogCPM -
            rowData(sce)$RefRankVarLogCPM
        colData(sce)$RefRankLibSize <- ref.libs[rank(colData(sce)$total_counts)]
        colData(sce)$RankDiffLibSize <- colData(sce)$total_counts -
            colData(sce)$RefRankLibSize
        rowData(sce)$RefRankZeros <- ref.z.gene[rank(
            rowData(sce)$pct_dropout_counts)]
        rowData(sce)$RankDiffZeros <- rowData(sce)$pct_dropout_counts -
            rowData(sce)$RefRankZeros
        colData(sce)$RefRankZeros <- ref.z.cell[rank(
            colData(sce)$PctZero)]
        colData(sce)$RankDiffZeros <- colData(sce)$PctZero -
            colData(sce)$RefRankZeros

        rowData(sce)$MeanRankVarDiff <- rowData(sce)$VarLogCPM -
            ref.vars.rank[rowData(sce)$RankCounts]
        rowData(sce)$MeanRankZerosDiff <- rowData(sce)$pct_dropout_counts -ref.z.gene.rank[rowData(sce)$RankCounts]

        sces[[name]] <- sce
    }

    ref.sce <- sces[[ref]]
    sces[[ref]] <- NULL

    features <- rowData(sces[[1]])
    cells <- colData(sces[[1]])

    colours <- scales::hue_pal()(length(sces))

    if (length(sces) > 1) {
        for (name in names(sces)[-1]) {
            sce <- sces[[name]]
            features <- rbindMatched(features, rowData(sce))
            cells <- rbindMatched(cells, colData(sce))
        }
    }

    features$Dataset <- factor(features$Dataset, levels = names(sces))
    cells$Dataset <- factor(cells$Dataset, levels = names(sces))
    features <- data.frame(features)
    cells <- data.frame(cells)


    if (length(sces) > 1) {
        for (name in names(sces)[-1]) {
            sce <- sces[[name]]
            features <- rbindMatched(features, rowData(sce))
            cells <- rbindMatched(cells, colData(sce))
        }
    }

    features$Dataset <- factor(features$Dataset, levels = names(sces))
    cells$Dataset <- factor(cells$Dataset, levels = names(sces))
    features <- data.frame(features)
    cells <- data.frame(cells)




    # mean.var <- ggplot(features,
    #                    aes_string(x = "RankCounts", y = "MeanRankVarDiff",
    #                               colour = "Dataset", fill = "Dataset")) +
    #     geom_hline(yintercept = 0, colour = "red") +
    #     geom_point(size = point.size, alpha = point.alpha,shape=46) +
    #     scale_colour_manual(values = colours) +
    #     scale_fill_manual(values = colours) +
    #     xlab("Expression rank") +
    #     ylab(expression(paste("Difference in variance ", log[2], "(CPM + 1)"))) +
    #     ggtitle("Difference in mean-variance relationship") +
    #     theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')



    z.gene <- ggplot(features,
                     aes_string(x = "Dataset", y = "RankDiffZeros",
                                colour = "Dataset")) +
        geom_hline(yintercept = 0, colour = "red") +
        geom_boxplot(show.legend=F) +
        scale_colour_manual(values = colours) +
        ylab(paste("Rank difference percentage zeros")) +
        ggtitle("Difference in zeros per gene") +
        theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')

    z.cell <- ggplot(cells,
                     aes_string(x = "Dataset", y = "RankDiffZeros",
                                colour = "Dataset")) +
        geom_hline(yintercept = 0, colour = "red") +
        geom_boxplot(show.legend=F) +
        scale_colour_manual(values = colours) +
        ylab(paste("Rank difference percentage zeros")) +
        ggtitle("Difference in zeros per cell") +
        theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')

    # mean.zeros <- ggplot(features,aes_string(x = "RankCounts", y = "MeanRankZerosDiff", colour = "Dataset", fill = "Dataset")) +
    #     geom_hline(yintercept = 0, colour = "red") +
    #     geom_point(size = point.size, alpha = point.alpha,shape=46) +
    #     scale_colour_manual(values = colours) +
    #     scale_fill_manual(values = colours) +
    #     xlab("Expression rank") +
    #     ylab("Difference in percentage zeros per gene") +
    #     ggtitle("Difference in mean-zeros relationship") +
    #     theme(legend.text = element_text(size = textsize),legend.title  = element_text(size = textsize),plot.title = element_text(size = textsize),axis.title = element_text(size = textsize),panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.subtitle = element_text(size = textsize),plot.caption =  element_text(size = textsize),axis.text=element_text(size=textsize) ,legend.key.size = unit(1,"line"),legend.position ='bottom')

    #return(list(mean.var=mean.var,z.gene=z.gene,z.cell=z.cell,mean.zeros=mean.zeros))
    return(list(z.gene=z.gene,z.cell=z.cell))
}#end
