# #Import Klein mouse cells 933 cells
# GSM1599494_ES_d0_main <- read.csv("E:/RNAseqProject/NEWPROJECT_PAPERS/Droplet Barcoding for Single-Cell Transcriptomics/allcsv/GSM1599494_ES_d0_main.csv",header=FALSE)
# #load(file='E:/RNAseqProject/PROJECT_CellSize/CELL_SIZE/Noise_detection/DIY_simulation_noise/Splatter_realdata/SplatEstimate_forTworealdata.RData')
# Whole_dat<-as.data.frame(GSM1599494_ES_d0_main)
# rownames(Whole_dat)<-Whole_dat[,1]
# Whole_dat<-Whole_dat[,-1]
# rm(GSM1599494_ES_d0_main)
# library(splatter)
# Rcpp::sourceCpp('E:/RNAseqProject/PROJECT_RNAseq/Rcpp_maybeuseful/DownSampling.cpp')
#
#
# Real_data<-Whole_dat
# dim(Real_data)
#
#
# rownames(Real_data)
# grep(rownames(Real_data),pattern='ERCC')
#
#
# library(SingleCellExperiment)
# system.time(Sim_List_Input<-trytt2(Real_data,inputMeanBeta=0.06,inputtrim=0.01,inputBeta=NULL))

##############################UMI Klein#############

#begin plot Klein###########
load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein933_DIY.RData")


library(scater)
library(SingleCellExperiment)
library(gridExtra)
library(ggplot2)

REAL<-SingleCellExperiment(assays=list(counts=as.matrix(Real_data)))
DIY_sim<-SingleCellExperiment(assays=list(counts=Sim_List_Input$SCE@assays@.xData$data$counts))
#N1_splatter_DAT<-SingleCellExperiment(assays=list(counts=N1_splatter_sim@assays@.xData$data$counts))
#listused_N1<-list(Real = REAL,Binomial =DIY_sim)
rownames(Sim_List_Input$SCE@assays@.xData$data$counts)<-rownames(Real_data)


listused_N1<-list(Real = as.matrix(Real_data),Binomial =as.matrix(Sim_List_Input$SCE@assays@.xData$data$counts))
save(listused_N1,file="E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein933_list.RData")
#save(Real_data,Sim_List_Input,DROPOUT_DAT,file="E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein933_DIY.RData")


source("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/DROPOUT_FUN.r")
D_Klein<-plot_DROPOUT(listused_N1,MAIN='(a)',CAPTION='(UMI: based on data from Klein et al. 2015)')
#D_Klein
save(D_Klein,file="E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/D_Klein.RData")






#####non UMI SCnorm H1 p24#####

load("E:/RNAseqProject/Bacher__SCnorm_2016/scaled_BAY/H1_bayNorm_esf_01.RData")
load("E:/RNAseqProject/Bacher__SCnorm_2016/RAW_INITIATE.RData")
library(splatter)
library(SingleCellExperiment)
Rcpp::sourceCpp('E:/RNAseqProject/PROJECT_RNAseq/Rcpp_maybeuseful/DownSampling.cpp')
source("E:/RNAseqProject/QQsim_v2_SingleCellExperiment.R")


#Our simulation
qq<-round(H1_p24/20)
system.time(H1p24_bay_sim<-trytt2(counts=qq,inputMeanBeta=1,inputtrim=0.01,inputBeta=Beta_H1[colnames(qq)]))
""

library(splatter)
class(H1_p24)
#splatter simulation
system.time(H1p24_splatter_est<-splatEstimate(as.matrix(H1_p24)))
system.time(H1p24_splatter_sim <- splatSimulate(H1p24_splatter_est))

#save(Beta_H1,H1_p24,H1p24_bay_sim,H1p24_splatter_est,H1p24_splatter_sim,file="E:/RNAseqProject/Bacher__SCnorm_2016/DIY_sim/H1p24_bay_sim_allgene.RData")

#begin plot H1_p24###########
load("E:/RNAseqProject/Bacher__SCnorm_2016/DIY_sim/H1p24_bay_sim_allgene.RData")

H1p24_real<-SingleCellExperiment(assays=list(counts=as.matrix(H1_p24)))
H1p24_bay_DAT<-SingleCellExperiment(assays=list(counts=H1p24_bay_sim$SCE@assays@.xData$data$counts))
H1p24_splatter_DAT<-SingleCellExperiment(assays=list(counts=H1p24_splatter_sim@assays@.xData$data$counts))




listused_H1p24<-list(Real = H1p24_real@assays@.xData$data$counts,Binomial =H1p24_bay_DAT@assays@.xData$data$counts)
save(listused_H1p24,file="E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/listused_H1p24.RData")


source("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/DROPOUT_FUN.r")
D_SCnorm<-plot_DROPOUT(listused_H1p24,MAIN='(b)',CAPTION='(non UMI: based on data from Bacher et al. 2017)')
#D_SCnorm
save(D_SCnorm,file="E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/D_SCnorm.RData")
#listused_N1<-list(Real = H1p24_real,Binomial =H1p24_bay_DAT,Splatter=H1p24_splatter_DAT)
#system.time(comparison_N1 <- compareSCEs(listused_N1,fits=F,point.size = 1,point.alpha = 0.5))
#system.time(difference_N1 <- diffSCEs(listused_N1, ref = "Real"))
#system.time(panel_N1 <- makeOverallPanel(comparison_N1 , difference_N1, title = "Overall comparison",row.labels = c("Means", "Variance","Mean-variance relationship","Library size", "Zeros per cell", "Zeros per gene","Mean-zeros relationship")))
#plot(panel_N1)





#######begin final output#######
source("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/DROPOUT_FUN.r")
load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein933_list.RData")
load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/listused_H1p24.RData")
# load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/D_Klein.RData")
# load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/D_SCnorm.RData")

source("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/DROPOUT_FUN.r")
 D_Klein<-plot_DROPOUT(listused_N1,MAIN='(a)',CAPTION='(UMI: based on data from Klein et al. 2015)')
 D_SCnorm<-plot_DROPOUT(listused_H1p24,MAIN='(b)',CAPTION='(non UMI: based on data from Bacher et al. 2017)')


ll<-list(D_Klein,D_SCnorm)
jpeg("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein_SCnorm.jpeg", width = 60, height = 30, units = 'in', res = 500)
#pdf("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Klein_SCnorm.pdf", width = 55, height = 30)
do.call("grid.arrange", c(ll,ncol=2,nrow=1))
dev.off()

#load("E:/RNAseqProject/PROJECT_scRNAseq/FIGURE_DROPOUT/DROPOUT_MAIN/Tung_Islam.RData")
